#!/bin/bash

# ==========================================
# Hysteria 2 终极安装脚本 V5.0
# 特性：伪装菜单 | 多系统兼容 | 管道兼容 | 零报错
# ==========================================

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
PLAIN='\033[0m'

# 全局变量
CONFIG_FILE="/etc/hysteria/config.yaml"
CERT_DIR="/etc/hysteria/certs"
CMD_PATH="/usr/bin/hy"

# 1. 系统与包管理器检测 (增强版)
check_sys() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}错误: 必须使用 root 用户运行此脚本！${PLAIN}"
        exit 1
    fi
    
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        OS=$ID
    fi

    # 优先检测包管理器命令
    if command -v apt-get &> /dev/null; then
        PM="apt"
        INSTALL_CMD="apt-get install -y"
        UPDATE_CMD="apt-get update"
    elif command -v dnf &> /dev/null; then
        PM="dnf"
        INSTALL_CMD="dnf install -y"
        UPDATE_CMD="dnf makecache"
    elif command -v yum &> /dev/null; then
        PM="yum"
        INSTALL_CMD="yum install -y"
        UPDATE_CMD="yum makecache"
    elif command -v apk &> /dev/null; then
        PM="apk"
        INSTALL_CMD="apk add"
        UPDATE_CMD="apk update"
    else
        echo -e "${RED}未检测到支持的包管理器 (apt/dnf/yum/apk)，脚本无法运行。${PLAIN}"
        exit 1
    fi
}

# 2. 保存防火墙规则 (适配全平台)
save_firewall() {
    if [[ "$PM" == "apt" ]]; then
        netfilter-persistent save > /dev/null 2>&1
    elif [[ "$PM" == "dnf" ]] || [[ "$PM" == "yum" ]]; then
        service iptables save > /dev/null 2>&1
    elif [[ "$PM" == "apk" ]]; then
        /etc/init.d/iptables save > /dev/null 2>&1
    fi
}

# 3. 生成管理菜单 (使用分段写入法，彻底解决 syntax error)
create_shortcut() {
    # 第一段：写入头部变量
    cat > $CMD_PATH <<EOF
#!/bin/bash
CONFIG_FILE="/etc/hysteria/config.yaml"
NODE_NAME="${CUSTOM_NAME}"
EOF

    # 第二段：写入核心逻辑 (使用 'EOF' 阻止变量转义，保证脚本内容原样写入)
    cat >> $CMD_PATH <<'EOF'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
PLAIN='\033[0m'

show_node_info() {
    echo -e "${GREEN}>>> 当前节点配置 ${PLAIN}"
    PORT=$(grep "^listen:" $CONFIG_FILE | awk '{print $2}' | tr -d ':')
    PASS=$(grep -A 5 "auth:" $CONFIG_FILE | grep "password:" | head -n 1 | awk '{print $2}')
    OBFS_PASS=$(grep -A 2 "salamander:" $CONFIG_FILE | grep "password:" | head -n 1 | awk '{print $2}')
    SERVER_IP=$(curl -s4 ifconfig.me)

    if grep -q "insecure: true" $CONFIG_FILE; then
        # --- 自签模式 ---
        FAKE_URL=$(grep "url:" $CONFIG_FILE | head -n 1 | awk '{print $2}')
        SNI_VAL=$(echo $FAKE_URL | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        
        echo -e "模式: ${YELLOW}自签证书 (IP直连)${PLAIN}"
        echo -e "IP:   ${YELLOW}${SERVER_IP}${PLAIN}"
        echo -e "端口: ${YELLOW}${PORT}${PLAIN}"
        echo -e "密码: ${YELLOW}${PASS}${PLAIN}"
        echo -e "------------------------------------------------"
        LINK="hysteria2://${PASS}@${SERVER_IP}:${PORT}?peer=${SNI_VAL}&insecure=1&obfs=salamander&obfs-password=${OBFS_PASS}&sni=${SNI_VAL}#${NODE_NAME}"
        echo -e "${CYAN}[节点链接]${PLAIN}"
        echo -e "${YELLOW}${LINK}${PLAIN}"
    else
        # --- 域名模式 ---
        DOMAIN=$(grep -A 1 "domains:" $CONFIG_FILE | tail -n 1 | tr -d ' -')
        SNI_VAL=$DOMAIN
        
        echo -e "模式: ${YELLOW}正规域名证书${PLAIN}"
        echo -e "域名: ${YELLOW}${DOMAIN}${PLAIN}"
        echo -e "IP:   ${YELLOW}${SERVER_IP}${PLAIN}"
        echo -e "端口: ${YELLOW}${PORT}${PLAIN}"
        echo -e "密码: ${YELLOW}${PASS}${PLAIN}"
        echo -e "------------------------------------------------"
        
        LINK_DOMAIN="hysteria2://${PASS}@${DOMAIN}:${PORT}?peer=${SNI_VAL}&insecure=0&obfs=salamander&obfs-password=${OBFS_PASS}&sni=${SNI_VAL}#${NODE_NAME}"
        LINK_IP="hysteria2://${PASS}@${SERVER_IP}:${PORT}?peer=${SNI_VAL}&insecure=0&obfs=salamander&obfs-password=${OBFS_PASS}&sni=${SNI_VAL}#${NODE_NAME}_IP"

        echo -e "${CYAN}1. 域名节点 (推荐):${PLAIN}"
        echo -e "${YELLOW}${LINK_DOMAIN}${PLAIN}"
        echo -e ""
        echo -e "${CYAN}2. IP 节点 (备用):${PLAIN}"
        echo -e "${YELLOW}${LINK_IP}${PLAIN}"
    fi
    echo ""
}

uninstall_logic() {
    echo -e "${RED}警告：这将删除 Hysteria2 程序、配置及防火墙规则。${PLAIN}"
    read -p "确认卸载? (y/n): " UN_CONFIRM < /dev/tty
    if [[ "$UN_CONFIRM" == "y" ]]; then
        echo -e "${GREEN}停止服务...${PLAIN}"
        if command -v systemctl &>/dev/null; then
            systemctl stop hysteria-server
            systemctl disable hysteria-server
            rm -f /etc/systemd/system/hysteria-server.service
            systemctl daemon-reload
        else
            rc-service hysteria-server stop
            rm -f /etc/init.d/hysteria-server
        fi
        
        rm -rf /etc/hysteria
        rm -f /usr/local/bin/hysteria
        rm -f /usr/bin/hy
        
        # 清理 iptables
        iptables -t nat -F PREROUTING
        ip6tables -t nat -F PREROUTING
        
        # 尝试保存空规则
        if command -v netfilter-persistent &> /dev/null; then
            netfilter-persistent save > /dev/null 2>&1
        elif [ -f "/etc/init.d/iptables" ]; then
            /etc/init.d/iptables save > /dev/null 2>&1
        fi

        echo -e "${GREEN}卸载完成。${PLAIN}"
        exit 0
    fi
}

# ====== 在这里插入 DNS 设置函数 ======
set_dns() {
    echo -e "${GREEN}正在配置防污染 DNS (DoH)...${PLAIN}"
    echo -e "1. Cloudflare (1.1.1.1)"
    echo -e "2. Google (8.8.8.8)"
    echo -e "3. Quad9 (9.9.9.9)"
    echo -e "4. 恢复默认"
    read -p "请选择: " dns_opt

    # 这里直接用脚本顶部的变量
    CFG="/etc/hysteria/config.yaml"
    
    # 清理旧配置
    if grep -q "^resolver:" "$CFG"; then sed -i '/^resolver:/,+8d' "$CFG"; fi

    case $dns_opt in
        1) cat <<CONFIG >> "$CFG"
resolver:
  type: https
  https:
    addr: 1.1.1.1:443
    timeout: 10s
    sni: cloudflare-dns.com
    insecure: false
CONFIG
        ;;
        2) cat <<CONFIG >> "$CFG"
resolver:
  type: https
  https:
    addr: 8.8.8.8:443
    timeout: 10s
    sni: dns.google
    insecure: false
CONFIG
        ;;
        3) cat <<CONFIG >> "$CFG"
resolver:
  type: https
  https:
    addr: 9.9.9.9:443
    timeout: 10s
    sni: dns.quad9.net
    insecure: false
CONFIG
        ;;
        4) echo "已恢复默认" ;;
        *) echo "错误" ; return ;;
    esac
    
    # 重启服务
    if command -v systemctl &>/dev/null; then 
        systemctl restart hysteria-server
    else 
        rc-service hysteria-server restart
    fi
    echo -e "${GREEN}设置完成，服务已重启${PLAIN}"
}
# ===================================


if [[ "$1" == "info" ]]; then
    show_node_info
    exit 0
fi

echo -e "========================="
echo -e "   Hysteria 2 管理面板   "
echo -e "========================="
echo -e "1) 查看运行状态"
echo -e "2) 查看节点链接"
echo -e "3) 修改配置文件"
echo -e "4) 重启服务"
echo -e "5) 停止服务"
echo -e "6) 设置 DNS/DoH (防污染)需手动开启" 
echo -e "9) ${RED}卸载并清理环境${PLAIN}"
echo -e "0) 退出"
echo -e "========================="
read -p "请选择: " OPTION < /dev/tty

case $OPTION in
    1) if command -v systemctl &>/dev/null; then systemctl status hysteria-server --no-pager; else /etc/init.d/hysteria-server status; fi ;;
    2) show_node_info ;;
    3) nano $CONFIG_FILE && echo "修改后请重启服务(选项4)" ;;
    4) 
       if command -v systemctl &>/dev/null; then 
           systemctl restart hysteria-server && echo -e "${GREEN}重启成功${PLAIN}"; 
       else 
           rc-service hysteria-server restart; 
       fi 
       ;;
    5) if command -v systemctl &>/dev/null; then systemctl stop hysteria-server; else rc-service hysteria-server stop; fi; echo "服务已停止" ;;
    6) set_dns ;;
    9) uninstall_logic ;;
    0) exit 0 ;;
    *) echo "无效选择" ;;
esac
EOF
    chmod +x $CMD_PATH
}

# ===========================
# 主安装流程
# ===========================

clear
check_sys
echo -e "${CYAN}Hysteria 2 安装脚本 (V5.0 终极版)${PLAIN}"
echo -e "${CYAN}当前系统: ${OS} (${PM})${PLAIN}"

# --- 1. 证书模式 ---
echo -e "------------------------------------------------"
echo -e "${YELLOW}[1/6] 证书模式${PLAIN}"
echo -e "1) 自签证书 (IP直连，最简单)"
echo -e "2) 域名证书 (推荐，需域名解析)"
read -p "选择 (默认1): " CERT_MODE < /dev/tty
[[ -z "$CERT_MODE" ]] && CERT_MODE="1"

if [[ "$CERT_MODE" == "2" ]]; then
    read -p "输入域名: " USER_DOMAIN < /dev/tty
    read -p "输入邮箱: " USER_EMAIL < /dev/tty
else
    USER_DOMAIN=$(curl -s4 ifconfig.me)
fi

# --- 2. 端口设置 ---
echo -e "------------------------------------------------"
read -p "设置端口 (默认 443): " PORT < /dev/tty
[[ -z "$PORT" ]] && PORT="443"

# --- 3. 伪装域名 (菜单化 + 手动) ---
echo -e "------------------------------------------------"
echo -e "${YELLOW}[3/6] 选择伪装域名 (Masquerade Domain)${PLAIN}"
echo -e "1) www.bing.com"
echo -e "2) www.tesla.com"
echo -e "3) www.apple.com"
echo -e "4) www.amazon.com"
echo -e "0) ${CYAN}手动输入其他域名${PLAIN}"
read -p "请选择 [0-4] (默认1): " MASQ_OPT < /dev/tty

case $MASQ_OPT in
    2) MASQ_DOMAIN="www.tesla.com" ;;
    3) MASQ_DOMAIN="www.apple.com" ;;
    4) MASQ_DOMAIN="www.amazon.com" ;;
    0) read -p "请输入伪装域名 (例如 www.baidu.com): " MASQ_DOMAIN < /dev/tty ;;
    *) MASQ_DOMAIN="www.bing.com" ;;
esac
[[ -z "$MASQ_DOMAIN" ]] && MASQ_DOMAIN="www.bing.com"
echo -e "已选择伪装: ${GREEN}$MASQ_DOMAIN${PLAIN}"

# --- 4. 端口跳跃 ---
echo -e "------------------------------------------------"
echo -e "${YELLOW}设置端口跳跃 (Port Hopping)${PLAIN}"
read -p "起始端口 (默认 35000): " HOP_START < /dev/tty
[[ -z "$HOP_START" ]] && HOP_START="35000"
read -p "结束端口 (默认 36000): " HOP_END < /dev/tty
[[ -z "$HOP_END" ]] && HOP_END="36000"

# --- 5. 出站网络 ---
echo -e "------------------------------------------------"
echo -e "${YELLOW}[5/6] 出站网络偏好${PLAIN}"
echo -e "1) IPv4 优先"
echo -e "2) IPv6 优先"
echo -e "3) 自动双栈 (Auto)"
read -p "请选择 (默认1): " NET_CHOICE < /dev/tty
case $NET_CHOICE in
    2) OUT_MODE="6" ;;
    3) OUT_MODE="auto" ;;
    *) OUT_MODE="4" ;;
esac

# --- 6. 节点名称 ---
echo -e "------------------------------------------------"
echo -e "${YELLOW}[6/6] 节点名称设置${PLAIN}"
read -p "请输入节点名称 (默认 Hy2-Node): " CUSTOM_NAME < /dev/tty
[[ -z "$CUSTOM_NAME" ]] && CUSTOM_NAME="Hy2-Node"

# --- 开始安装 ---
echo -e "${GREEN}>>> 更新软件源并安装依赖 ($PM)...${PLAIN}"
$UPDATE_CMD
case $PM in
    apt) $INSTALL_CMD curl openssl iptables iptables-persistent netfilter-persistent ;;
    dnf|yum) $INSTALL_CMD curl openssl iptables iptables-services; systemctl enable --now iptables ;;
    apk) $INSTALL_CMD curl openssl iptables ip6tables nano ;;
esac

echo -e "${GREEN}>>> 下载 Hysteria 2 核心...${PLAIN}"
HYSTERIA_USER=root bash <(curl -fsSL https://get.hy2.sh/)

echo -e "${GREEN}>>> 生成配置文件...${PLAIN}"
PASSWORD=$(cat /proc/sys/kernel/random/uuid)
OBFS_PASSWORD=$(openssl rand -hex 8)
mkdir -p $CERT_DIR

cat > $CONFIG_FILE <<EOF
listen: :$PORT
auth:
  type: password
  password: $PASSWORD
obfs:
  type: salamander
  salamander:
    password: $OBFS_PASSWORD
quic:
  initStreamReceiveWindow: 8388608
  maxStreamReceiveWindow: 8388608
  initConnReceiveWindow: 20971520
  maxConnReceiveWindow: 20971520
  maxIdleTimeout: 30s
  maxIncomingStreams: 1024
  disablePathMTUDiscovery: false
speedTest: true
disableUDP: false
udpIdleTimeout: 60s
EOF

if [[ "$CERT_MODE" == "2" ]]; then
    cat >> $CONFIG_FILE <<EOF
acme:
  domains:
    - $USER_DOMAIN
  email: $USER_EMAIL
masquerade:
  type: proxy
  proxy:
    url: https://$MASQ_DOMAIN
    rewriteHost: true
  listenHTTPS: :$PORT
outbounds:
  - name: direct_out
    type: direct
    direct:
      mode: $OUT_MODE
      fastOpen: true
EOF
else
    openssl ecparam -genkey -name prime256v1 -out $CERT_DIR/self.key
    openssl req -new -x509 -days 36500 -key $CERT_DIR/self.key -out $CERT_DIR/self.crt -subj "/CN=$MASQ_DOMAIN"
    chmod 644 $CERT_DIR/self.key $CERT_DIR/self.crt
    cat >> $CONFIG_FILE <<EOF
tls:
  cert: $CERT_DIR/self.crt
  key: $CERT_DIR/self.key
masquerade:
  type: proxy
  proxy:
    url: https://$MASQ_DOMAIN
    rewriteHost: true
    insecure: true
  listenHTTPS: :$PORT
outbounds:
  - name: direct_out
    type: direct
    direct:
      mode: $OUT_MODE
      fastOpen: true
EOF
fi

# --- 防火墙 ---
echo -e "${GREEN}>>> 配置端口转发...${PLAIN}"
iptables -t nat -F PREROUTING
ip6tables -t nat -F PREROUTING
iptables -t nat -A PREROUTING -p udp --dport $HOP_START:$HOP_END -j REDIRECT --to-ports $PORT
ip6tables -t nat -A PREROUTING -p udp --dport $HOP_START:$HOP_END -j REDIRECT --to-ports $PORT
save_firewall

# --- 启动 ---
if [[ "$PM" == "apk" ]]; then
    cat > /etc/init.d/hysteria-server <<EOF
#!/sbin/openrc-run
name="Hysteria 2 Server"
command="/usr/local/bin/hysteria"
command_args="server -c /etc/hysteria/config.yaml"
command_background=true
pidfile="/run/hysteria-server.pid"
depend() { need net; after firewall; }
EOF
    chmod +x /etc/init.d/hysteria-server
    rc-update add hysteria-server default
    rc-service hysteria-server restart
else
    systemctl enable hysteria-server
    systemctl restart hysteria-server
fi

create_shortcut

# --- 结束处理 ---
clear
echo -e "${GREEN}=========================================${PLAIN}"
echo -e "${GREEN}      安装完成！(Install Complete)       ${PLAIN}"
echo -e "${GREEN}=========================================${PLAIN}"
echo -e "输入 ${YELLOW}hy${PLAIN} 再次查看此信息。"
sleep 1
hy info
